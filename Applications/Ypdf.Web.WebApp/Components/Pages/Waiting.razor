@page "/waiting"
@attribute [StreamRendering]

<PageTitle>Waiting</PageTitle>

<div class="container my-5 text-center">
    <h2 class="mb-4">Please wait while the operation is being processed</h2>
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <div class="mt-4">
        <h5>Elapsed Time: <span id="timer">0</span> seconds</h5>
    </div>
    <div id="result" class="mt-4"></div>
</div>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" integrity="sha384-k6RqeWeci5ZR/Lv4MR0sA0FfDOM6g1z5z5z5z5z5z5z5z5z5z5z5z5z5z5z5z5" crossorigin="anonymous" />
<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css" />

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
    $(document).ready(function () {
        let seconds = 0;
        const timerElement = $('#timer');
        const resultElement = $('#result');

        let attempts = 0;
        const maxAttempts = 10;

        timerElement.text(seconds);

        const interval = setInterval(function () {
            seconds++;
            timerElement.text(seconds);
        }, 1000);

        function checkOperationStatus() {
            $.get('https://localhost:8082/api/output/check/', function (data) {
                if (data.completed) {
                    clearInterval(interval);
                    resultElement.html(`
                        <h5>Operation completed successfully!</h5>
                        <a href="${data.downloadLink}" class="btn btn-success mt-3">Download File</a>
                        <button class="btn btn-info mt-3" onclick="copyLink('${data.downloadLink}')">Copy Link</button>
                    `);
                } else {
                    attempts++;
                    if (attempts >= maxAttempts) {
                        clearInterval(interval);
                        resultElement.html(`
                            <h5>Something went wrong!</h5>
                            <p>We are unable to get the result from the server after multiple attempts.</p>
                        `);
                    } else {
                        setTimeout(checkOperationStatus, 2000); // Wait 2 seconds before the next request
                    }
                }
            }).fail(function () {
                clearInterval(interval);
                resultElement.html(`
                    <h5>Error occurred!</h5>
                    <p>Unable to reach the server. Please try again later.</p>
                `);
            });
        }

        // Start checking the operation status
        checkOperationStatus();

        // Function to copy the download link to clipboard
        window.copyLink = function (link) {
            navigator.clipboard.writeText(link).then(function () {
                alert('Link copied to clipboard!');
            }, function () {
                alert('Failed to copy the link.');
            });
        };
    });
</script>
